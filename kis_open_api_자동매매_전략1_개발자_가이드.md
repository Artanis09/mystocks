# KIS Open API 기반 자동매매 개발자 가이드

**전략 대상:** 전략 1 – 상한가 갭상승 모멘텀  
**목표:** 전일 상한가 종목을 대상으로 당일 시초 갭 조건을 만족할 경우 자동 진입하고, 명확한 TP/SL/EOD 규칙으로 청산하는 안정적인 자동매매 시스템 구현

---

## 0. 문서 범위와 전제

### 전략 파라미터(문서 기준)
- **Setup**
  - 전일 종가 기준 상한가 도달(수익률 ≥ 29.5%)
  - 시가총액 ≥ 500억
- **Execution**
  - 진입: 당일 시가(또는 시초 기준가)가 전일 종가 대비 +2% 이상 갭상승 시 매수
  - 익절(TP): +10%
  - 손절(SL): -3%
  - EOD: 장 마감 전 전량 청산

### KIS Open API 전제
- Access Token 유효기간 24시간, 재발급 정책 준수 필요
- 국내주식 시세 조회, 주문, 체결/잔고 조회 기능 활용
- REST + (가능 시) WebSocket 혼합 구조 권장

---

## 1. 구현 가능성 평가

### 1.1 기능 구현 가능성
- 시세 조회, 주문, 체결 조회 모두 KIS Open API로 구현 가능
- 전략 규칙이 명확하여 상태 머신 기반 자동화에 적합

### 1.2 실전 리스크
- 시초가 확정 지연
- 시장가 주문 슬리피지 확대
- 손절 구간 체결 실패(VI, 호가 공백)
- 네트워크 장애로 주문 상태 불명확

→ **결론:** 전략 로직보다 예외 처리와 상태 관리가 성공의 핵심

---

## 2. 권장 아키텍처

### 2.1 컴포넌트 구성
1. **Market Calendar / Scheduler**  
   - 거래일/휴장/조기폐장 관리
   - 전략 실행 타임라인 제어

2. **Universe Builder**  
   - 전일 상한가 + 시총 필터 적용
   - watchlist 생성 및 저장

3. **Signal Engine**  
   - 시초 갭 조건 판단
   - 다회 확인(노이즈 제거)

4. **Execution Engine**  
   - 주문 생성/전송/취소/정정
   - 체결 기반 포지션 확정

5. **Risk Manager**  
   - TP/SL/EOD 트리거 관리
   - 계좌/전략 레벨 가드레일

6. **State Store(DB/Redis)**  
   - 종목별 전략 상태 영속 저장
   - 장애 재기동 시 중복 주문 방지

7. **Observability**  
   - 로그, 메트릭, 알림

---

## 3. 상태 머신 설계

### 3.1 상태 정의
- `IDLE`
- `WATCHING`
- `ENTRY_PENDING`
- `ENTERED`
- `EXIT_PENDING`
- `CLOSED`
- `SKIPPED`
- `ERROR`

### 3.2 상태 전이
- WATCHING → ENTRY_PENDING : 갭 조건 충족
- ENTRY_PENDING → ENTERED : 체결 확인
- ENTERED → EXIT_PENDING : TP/SL/EOD 트리거
- EXIT_PENDING → CLOSED : 전량 청산 완료

---

## 4. 전략 타임라인

### D-1 (전일 장 마감 후)
- Universe Builder 실행
- watchlist 저장

### D-day 준비(08:40~08:59)
- 토큰 검증/재발급
- 잔고/주문 가능 여부 확인
- 실시간 시세 채널 연결

### 시초 진입(09:00~09:03)
- 기준가 정의: 첫 체결가 또는 Best Ask
- 갭 ≥ +2% 조건 2회 연속 확인 후 진입

### 장중 관리(09:00~15:20)
- TP/SL 실시간 감시
- VI/거래정지 이벤트 대응

### EOD 청산(15:20~15:30)
- 단계적 전량 매도
- 미체결 잔량 강제 청산

---

## 5. 주문/체결 구현 가이드

### 5.1 진입 주문 모드
- **시장가:** 단순하지만 슬리피지 큼
- **공격 지정가(권장):**
  - Best Ask + N틱
  - 상한가 이내로 제한

### 5.2 부분체결 처리
- 평균단가 기반 TP/SL 재계산
- 체결 이벤트 기준 상태 갱신

### 5.3 주문 불명확 상태 처리
- 재전송 금지
- 반드시 주문/체결 조회로 상태 확정
- Idempotency Key 사용 권장

---

## 6. 예외처리 사양

### 6.1 인증/통신
- 401/403 → 토큰 재발급 후 재시도
- 반복 실패 시 신규 진입 중단 + 알림

### 6.2 주문 거부
- 잔고 부족, 거래 불가 종목
- 해당 종목 SKIPPED 처리

### 6.3 VI/상·하한가
- 손절 트리거 후 재호가 반복
- 시간 초과 시 강제 청산

### 6.4 데이터 이상
- 종가/시총/시초 데이터 NULL
- 보수적으로 제외(SKIPPED)

---

## 7. 리스크 가드레일

### 7.1 계좌 레벨
- 일일 최대 손실 한도
- 최대 동시 보유 종목 수 제한

### 7.2 전략 레벨
- 동일 종목 당일 1회 진입
- 진입 시간 제한(시초 구간만 허용)

---

## 8. Universe 산출 기준

- 전일 상한가 판정 시:
  - 수익률 ≥ 29.5%
  - 고가/종가가 상한가 근접 여부 확인
- 시총 데이터 불확실 시 제외

---

## 9. 로깅 / 메트릭 / 알림

### 9.1 로그 필드 예시
- timestamp, strategy_version
- symbol, phase, event
- prev_close, exec_price, gap
- order_id, qty, avg_price
- TP/SL 가격, 청산 사유

### 9.2 메트릭
- 주문 성공률
- 평균 슬리피지
- TP/SL 비율

### 9.3 알림
- 토큰 실패
- 주문 거부
- 청산 지연
- EOD 이후 잔존 포지션

---

## 10. 테스트 전략

1. **모의투자 환경**
   - 주문/체결/취소 전 흐름 검증
2. **실계좌 소액 테스트**
   - 체결 품질 및 슬리피지 계측
3. **장기 운영 검증**
   - 월간 성과/리스크 리포트 자동화

---

## 11. 최소 의사코드 예시

```python
if gap_confirmed(symbol):
    enter_position(symbol)

if price >= tp:
    exit(symbol, reason="TP")
elif price <= sl:
    exit(symbol, reason="SL")

if is_eod():
    exit(symbol, reason="EOD")
```

---

## 12. 핵심 요약

- 상태 머신 기반 설계 필수
- 시초 데이터 확정/체결 리스크 통제
- 조회 기반 예외 복구 로직
- 관측(로그/메트릭/알림) 없이는 운영 불가

---

**다음 단계 제안**
- Python / Java 기준 모듈 구조 문서화
- KIS Open API 엔드포인트 매핑 표
- 전략별 설정값 YAML/JSON 스키마 정의


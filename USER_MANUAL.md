# MyStock AI Trading System - 사용자 매뉴얼 (User Manual)

이 문서는 MyStock 프로젝트의 설치, 설정, 실행 및 데이터 관리에 대한 상세 가이드를 제공합니다.

---

## 🏗️ 1. 사전 준비 및 설치 (Installation)

### 1-1. Python 환경 설정
Python 3.10 이상 사용을 권장합니다.

```bash
# 가상환경 생성 (최초 1회)
python -m venv .venv

# 가상환경 활성화 (Windows)
.venv\Scripts\activate

# 가상환경 활성화 (Mac/Linux)
source .venv/bin/activate
```

### 1-2. 필수 패키지 설치 (Requirements)
`requirements.txt` 파일을 통해 필요한 라이브러리를 일괄 설치합니다.

```bash
pip install -r requirements.txt
```

---

## � 1-3. 프론트엔드 엔진 업데이트 (Lightweight Charts)
이 프로젝트는 가독성 높은 금융 차트를 제공하기 위해 Recharts에서 **Lightweight Charts** (TradingView 기술)로 마이그레이션되었습니다.

```bash
# 새로운 라이브러리 설치 반영을 위해 빌드 필요
docker compose build frontend
```

---

## �🔑 2. 보안 및 환경 설정 (.env)

**⚠️ 보안 주의:** API Key는 절대 Git 저장소(Github 등)에 업로드하지 마세요. 이 프로젝트는 `.env` 파일을 통해 키를 안전하게 관리합니다.

### 2-1. `.env` 파일 생성
프로젝트 최상위 경로(루트)에 `.env` 파일을 생성하고 아래 내용을 본인의 키로 채워 작성하세요.

```ini
# 한국투자증권(KIS) API 설정
KIS_APP_KEY=본인의_KIS_APP_KEY
KIS_APP_SECRET=본인의_KIS_APP_SECRET

# DART(전자공시시스템) API 설정
DART_API_KEY=본인의_DART_API_KEY
```

*   **참고:** `kis_token.json` 파일은 API 호출 시 자동 생성되는 임시 토큰 파일이므로 직접 생성할 필요가 없습니다.

---

## 🔄 3. 데이터 파이프라인 및 실행 순서 (Workflow)

시스템 구동을 위해서는 **[데이터 수집] -> [AI 예측] -> [웹 서버 실행]** 의 순서를 권장합니다. 최근 개편으로 인해 많은 부분이 **자동 스케줄러**로 통합되었습니다.

### 🕒 자동 스케줄러 주요 일정
백엔드 서버(`update_stock_prices.py`)가 실행 중이면 다음 작업이 자동으로 수행됩니다:
- **오후 4:00 (16:00):** EOD 데이터 전체 수집 (자동 실행)
- **오후 8:00 (20:00):** 내일 거래용 유니버스(상한가 종목) 자동 구축
- **오전 8:35 (08:35):** 장 시작 전 자동매매 엔진 자동 시작 체크

---

### Step 1. 데이터 수집: `crawl.py`
주로 과거 데이터를 재수집하거나 수동으로 업데이트할 때 사용합니다. 스케줄러가 정기적으로 수집하므로 평소에는 직접 실행할 필요가 없습니다.

```bash
# 수동 EOD 수집 예시
python crawl.py --mode eod --workers 2 --merge
```

> **📋 `crawl.py` 작동 원리 (상세)**
>
> 1.  **증분 업데이트 (Incremental Update)**
>     *   마지막으로 저장된 데이터 날짜를 확인합니다.
>     *   마지막 날짜가 '어제' 이전이라면, 빠진 날짜(Gap)만큼 데이터를 순차적으로 수집하여 쌓습니다.
>
> 2.  **오늘 데이터 갱신 (Overwrite)**
>     *   프로그램 실행 시점이 '오늘'이라면, 장 중이거나 장 마감 후 여부에 상관없이 **오늘 자 데이터를 다시 수집하여 기존 데이터를 덮어씁니다.**
>     *   이를 통해 장 마감 후 최종 확정된 종가(Close Price)를 확실하게 업데이트할 수 있습니다.
>     *   따라서 `crawl.py`는 하루에 여러 번 실행해도 데이터가 꼬이지 않고 안전하게 최신화됩니다.

### Step 2. AI 모델 예측: `ml/inference.py`
수집된 최신 데이터를 바탕으로 내일 상승할 확률이 높은 종목을 예측합니다.

```bash
python ml/inference.py
```
*   **기능:** 전체 종목을 대상으로 AI 모델이 상승 확률을 계산하고, 상위 추천 종목을 DB(`stock.db`)에 저장합니다.
*   **결과 확인:** 실행 후 웹 대시보드의 '추천 종목' 탭에서 결과를 볼 수 있습니다.
*   **모델 학습 (`ml/train.py`):** 기본 모델이 포함되어 있으므로 평소에는 실행할 필요가 없습니다. 모델 성능을 개선하거나 새 데이터를 학습시키고 싶을 때만 `python ml/train.py`를 실행하세요.

### Step 3. 웹 애플리케이션 실행
백엔드와 프론트엔드 서버를 모두 실행하여 서비스를 이용합니다.

**3-1. 백엔드 (Flask) 실행**
```bash
python update_stock_prices.py
```
*   **포트:** 5000 (`http://localhost:5000`)
*   **역할:** API 서버, DB 입출력 담당, KIS API를 통한 실시간 시세 및 자산 정보 조회

**3-2. 프론트엔드 (React/Vite) 실행**
새로운 터미널 창을 열고 실행하세요.
```bash
npm run dev
```
*   **포트:** 3000 (`http://localhost:3000`)
*   **역할:** 사용자 인터페이스 (대시보드, 차트, 매매입력)

---

## 📂 4. 폴더 및 데이터 구조 설명

```text
마이스탁/
├── .env                  # (필수) API Key 관리 파일 (Git 무시됨)
├── crawl.py              # 데이터 수집 스크립트
├── update_stock_prices.py # 백엔드 서버 메인 파일
├── requirements.txt      # 파이썬 패키지 목록
├── data/                 # 로컬 데이터 저장소 (Parquet 파일)
│   └── krx/
│       ├── daily_price/  # (구버전) 일별 주가 데이터
│       └── bars/         # (신버전) 차트용 OHLCV 데이터 (날짜별 파티셔닝)
├── ml/                   # 머신러닝 관련 코드
│   ├── inference.py      # AI 추천 실행 스크립트
│   ├── train.py          # 모델 학습 스크립트
│   └── models/           # 학습 완료된 CatBoost 모델 파일 (.cbm)
└── instance/
    └── stock.db          # SQLite 데이터베이스 (사용자 매매일지, 추천 이력 등)
```

---

## ❓ 5. 자주 묻는 질문 (Troubleshooting)

**Q1. `crawl.py` 실행 시 "No module named dotenv" 에러가 발생합니다.**
> A. `requirements.txt`에 포함된 패키지가 설치되지 않았습니다. 아래 명령어를 실행하세요.
> ```bash
> pip install -r requirements.txt
> ```

**Q2. 오늘 AI 추천 종목이 보이지 않습니다.**
> A. 다음 단계를 확인해 보세요.
> 1. `crawl.py`를 실행하여 오늘 날짜의 데이터 폴더(`data/krx/bars/date=YYYY-MM-DD`)가 생성되었는지 확인합니다.
> 2. `ml/inference.py`를 실행하여 에러 없이 완료되었는지 확인합니다.
> 3. 웹 화면에서 페이지를 새로고침하거나 상단의 "AI 수동 실행" 버튼을 눌러보세요.

**Q3. 실시간 가격이 0원으로 표시됩니다.**
> A. `.env` 파일에 KIS API Key가 올바르게 입력되었는지 확인하세요. 또한 장 운영 시간이 아니라면 전일 종가가 표시되어야 하는데, API 호출 한도를 초과했거나 모의투자/실전투자 도메인 설정이 잘못되었을 수 있습니다.

**Q4. Git에 코드를 올릴 때 주의할 점이 있나요?**
> A. 네, `.env` 파일과 `kis_token.json` 파일, 그리고 `data/` 폴더 안의 대용량 데이터들은 `.gitignore`에 등록되어 있어 올라가지 않습니다. 이 설정 파일을 유지해 주세요.

---

## 🔄 6. 투자 모드 전환 (실전/모의)

### 6-1. 투자 모드란?
앱에서는 두 가지 투자 모드를 지원합니다:

| 모드 | 설명 | 표시 |
|------|------|------|
| **🟢 모의투자** | 가상 자금으로 테스트. 실제 돈이 움직이지 않음 | 녹색 표시 |
| **🔴 실전투자** | 실제 계좌에서 주문 체결. 실제 돈이 움직임 | 빨간색 표시 (깜빡임) |

### 6-2. 모드 전환 방법
1. **AI 추천** 화면의 **투자 모드 패널** 확인
2. **모의투자** 또는 **실전투자** 버튼 클릭
3. 확인 팝업에서 **확인** 선택
4. 전환 완료 후 계좌 정보가 초기화됨 (새로고침 필요)

> ⚠️ **주의**: 실전투자 모드에서는 실제 주문이 체결됩니다. 신중하게 사용하세요!

### 6-3. 환경변수 설정
`.env` 파일에 실전/모의 투자용 키를 모두 설정해야 전환이 가능합니다:

```ini
# 모의투자용 (기본)
KIS_APP_KEY=모의투자_APP_KEY
KIS_APP_SECRET=모의투자_APP_SECRET
KIS_ACCOUNT_NO=모의투자_계좌번호-01
KIS_MOCK=true

# 실전투자용
KIS_REAL_APP_KEY=실전투자_APP_KEY
KIS_REAL_APP_SECRET=실전투자_APP_SECRET
KIS_REAL_ACCOUNT_NO=실전투자_계좌번호-01
```

---

## 💰 7. 매수/매도 비율 설정

### 7-1. 매수 비율 (Buy Ratio)
- **의미**: 총자산 대비 종목별 매수 금액 비율
- **기본값**: 10%
- **설정 범위**: 1% ~ 100%
- **계산 예시**: 
  - 총자산 1,000만원, 매수비율 10% → 종목당 **100만원** 매수
  - 삼성전자 현재가 70,000원 → 100만원 ÷ 70,000원 = **14주 매수**

### 7-2. 매도 비율 (Sell Ratio)
- **의미**: 보유수량 대비 분할매도 비율
- **기본값**: 50%
- **설정 범위**: 1% ~ 100%
- **계산 예시**:
  - 삼성전자 100주 보유, 매도비율 50% → **50주 매도**
  - 매도비율 100% → **전량 매도**

### 7-3. 설정 방법
1. **매매 설정** 패널 클릭하여 확장
2. **슬라이더** 또는 **숫자 입력**으로 비율 조정
3. 설정은 즉시 적용됨 (저장 버튼 불필요)

---

## 🛒 8. 개별 매수/매도 기능

### 8-1. 종목별 매수 버튼
추천 종목 카드의 **매수** 버튼을 클릭하면:

1. **사전 확인**
   - 계좌 총자산 확인 (없으면 계좌 새로고침 요청)
   - 현재가 확인 (KIS API 실시간 시세)
   
2. **매수 수량 자동 계산**
   ```
   매수금액 = 총자산 × 매수비율(%)
   매수수량 = 매수금액 ÷ 현재가 (소수점 버림)
   ```

3. **확인 팝업 표시**
   ```
   [시장가 매수 확인]
   종목명: 삼성전자 (005930)
   현재가: 70,000원
   매수비율: 총자산의 10%
   예상금액: 1,000,000원
   매수수량: 14주
   
   매수하시겠습니까?
   ```

4. **주문 실행**
   - **확인** 클릭 → KIS API로 시장가 매수 주문 전송
   - **취소** 클릭 → 주문 취소

5. **결과 알림**
   - 성공: `매수 주문 완료! 주문번호: XXXXX`
   - 실패: `매수 실패: [에러 메시지]`

### 8-2. 종목별 매도 버튼
추천 종목 카드의 **매도** 버튼을 클릭하면:

1. **사전 확인**
   - 해당 종목 보유수량 확인
   - 보유수량 없으면 매도 불가 안내

2. **매도 수량 자동 계산**
   ```
   매도수량 = 보유수량 × 매도비율(%) (소수점 버림)
   ```

3. **확인 팝업 표시**
   ```
   [시장가 매도 확인]
   종목명: 삼성전자 (005930)
   현재가: 70,000원
   매도비율: 보유의 50%
   보유수량: 100주
   매도수량: 50주
   
   매도하시겠습니까?
   ```

4. **주문 실행 및 결과**
   - 개별 매수와 동일한 흐름

---

## 📦 9. 일괄 매수/매도 기능

### 9-1. 종목 선택
1. 추천 종목 카드의 **체크박스** 클릭
2. 여러 종목 선택 가능
3. 선택된 종목 수가 버튼에 표시됨

### 9-2. 일괄 매수 (Batch Buy)
1. 원하는 종목들 체크박스 선택
2. **선택종목 일괄 매수** 버튼 클릭
3. 매수비율을 선택 종목 수로 **균등 분배**
   ```
   예: 5종목 선택, 매수비율 50%
   → 종목당 10%씩 (총자산의 10%) 매수
   ```
4. 주문 확인 팝업에서 상세 내역 확인
5. **확인** → 순차적으로 주문 실행

### 9-3. 일괄 매도 (Batch Sell)
1. 보유 종목들 체크박스 선택
2. **선택종목 일괄 매도** 버튼 클릭
3. 각 종목별로 매도비율 적용
4. 보유하지 않은 종목은 자동 제외

---

## 🤖 10. AI 종목 분석

### 10-1. 분석 서비스 선택
- **GPT (OpenAI)**: GPT-4o 모델 사용, 더 정확한 분석
- **Gemini (Google)**: Gemini 2.0 Flash 모델 사용, 빠른 응답

### 10-2. 분석 내용
- 최신 뉴스 기반 위험 요소 확인
- 상장폐지/거래정지 등 크리티컬 위험 감지
- 단기 매매 관점 조언 (3줄 이내)

### 10-3. 분석 결과 표시
- **⚠️ 매매금지**: 빨간색 배경, 위험 종목
- **일반 분석**: 파란색 배경, 매매 참고용

### 10-4. 자동 분석 (스케줄러)
- 매일 오후 3시 스케줄러 실행 시 자동 분석
- 추천 종목 상위 5개에 대해 GPT 분석 실행
- 결과는 DB에 저장되어 다음 접속 시에도 확인 가능

---

## ⏰ 11. 자동 스케줄러

### 11-1. 실행 시간표
| 시간 | 작업 | 설명 |
|------|------|------|
| 09:00-10:00 | EOD 데이터 수집 | 어제까지의 종가 데이터 업데이트 |
| 15:00-15:30 | 장중 데이터 수집 | 오늘 데이터 수집 |
| 15:00-15:30 | AI 예측 실행 | 내일 상승 종목 예측 |
| 15:00-15:30 | AI 종목 분석 | 추천 종목 GPT 분석 |

### 11-2. 스케줄러 상태 확인
- 화면 상단에 현재 스케줄러 상태 표시
- **EOD 수집중** / **장중 수집중**: 데이터 수집 진행 중
- **오늘 분석 완료**: 스케줄러 작업 완료

---

## 🔔 12. 알림 기능 (Ntfy)

### 12-1. 알림 종류
- AI 예측 완료 알림
- 추천 종목 목록 알림

### 12-2. 알림 수신
- 휴대폰에 **Ntfy** 앱 설치
- 토픽 구독: `wayne-akdlrjf0924`
- URL: `https://ntfy.sh/wayne-akdlrjf0924`

---

## 📞 지원 및 문의

문의사항이 있으시면 GitHub Issues를 이용해주세요.
